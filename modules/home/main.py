from datetime import datetime

from flask import request
import wbdata


import rpy2.robjects as robjects
from rpy2.robjects import FloatVector
from rpy2.robjects.packages import importr
from modules.rpy2_wrap import functions as rpy2functions
base = importr('base')
stats = importr('stats')

__author__ = 'aditya'

from flask import render_template, Blueprint, session, jsonify
from modules.opendataGet import functions

home = Blueprint("home", __name__, static_folder='static', static_url_path='/static/')

import os
import json
from config import BASE_DIR, APP_STATIC


@home.route('/')
def main():
    categories = json.loads(open(
        os.path.join(APP_STATIC, "data/categories.json"),
        "r").read())
    return render_template("index.html")



@home.route('/indData/<ind>', defaults={'y2': '2010', 'y2': datetime.now().year}, methods=['GET'])
@home.route('/indData/<ind>/<y1>', defaults={'y2': datetime.now().year}, methods=['GET'])
@home.route('/indData/<ind>/<y1>/<y2>', methods=['GET'])
def get_ind_data(y1=None, y2=None, ind=None):
    if ind:
        if y1:
            y1 = datetime(int(y1), 1, 1)
        if y2:
            y2 = datetime(int(y2), 1, 1)
        return jsonify(**functions.get_data(variable=ind, from_date=y1, to_date=y2))
    return {}


preview_countries = ['SE', 'US', 'HK', 'SG', 'IN', 'CN', 'NL', 'CH', 'AU', 'IS', 'EU', 'IE', 'BR']
@home.route('/indDataPreview/<ind>', defaults={'y1': '2010'}, methods=['GET'])
@home.route('/indDataPreview/<ind>/<y1>', methods=['GET'])
def get_ind_preview(y1=2010, ind="FR.INR.LEND"):
    if ind:
        if y1:
            ydt = datetime(int(y1), 1, 1)
        ind_details = wbdata.get_indicator(ind, display=False)[0]
        ind_details['dev'] = "Feel free to use this variable!"
        try:
            data = rpy2functions.get_values(wbdata.get_data(ind, data_date=(ydt, ydt), country=preview_countries))
            if 'q' in data.keys()[0].split('.')[0].lower():
                ind_details['dev'] = "If chosen, please make sure all variables are quarterly."
            if len(data) < 5:
                ind_details['dev'] = "Very scarce data. Avoid using this variable."
        except TypeError as e:
            data = {'{0}.{1}'.format(str(y1), cont):'ERROR' for cont in preview_countries}
            ind_details['dev'] = "No data found for this variable. Do not use this variable."
        return jsonify({'data': data, 'details': ind_details})
    return {}


@home.route('/regress', methods=['POST'])
def regress(debug = True):
    if request.method == 'POST':
        if debug:
            return jsonify({"error": 0, "mapData": {"BX.TRF.PWKR.CD.DT": {"2010": {"BD": 11281690013.660601, "BF": 120344771.51952299, "BA": 1822304847.0247099, "BO": 960212746.78550601, "BI": 34498929.5130741, "BJ": 139433078.846977, "BT": 8273480.8646051604, "JM": 2026445824.97593, "BW": 22321291.5539511, "BR": 2754111178.8000002, "BY": 575300000.0, "BZ": 78134569.592212304, "RW": 106467379.17835, "RS": 3348821903.2037601, "TJ": 2305826625.0, "GW": 45890277.965663701, "GT": 4231750980.0, "GY": 367805406.29125297, "GE": 1183935749.72, "GN": 46260000.0, "GM": 115699060.997021, "GH": 135852160.0, "OM": 39011703.511053301, "JO": 3517042253.5211201, "HR": 1211501366.37287, "HT": 1473804720.8907399, "HN": 2617906839.3902502, "PS": 1509397867.9463799, "PY": 409885000.0, "PA": 410000000.0, "PG": 3493553.6274272101, "PE": 2533910907.2957702, "PK": 9690000000.0, "PH": 21556633835.602501, "ZM": 43657312.0, "EG": 12453100000.0, "ZA": 1069571380.61167, "EC": 2599027038.6799998, "VN": 8260000000.0, "SB": 12664645.4741368, "ET": 345150775.48576897, "ME": 301052164.63228297, "MD": 1351430000.0, "MA": 6422542513.7161798, "MM": 114854849.288762, "ML": 472745533.91687101, "MN": 266242560.54764199, "MK": 387931157.0, "MW": 21767544.644241899, "UG": 770789132.02229595, "MY": 1102925378.35443, "MX": 22080259156.0, "MZ": 138558459.25999999, "FJ": 173767218.82134601, "NI": 824800000.0, "NA": 15120600.163624801, "NE": 134292521.36276999, "NG": 19817843641.7827, "NP": 3468877630.55477, "CI": 373477565.77847999, "CO": 4030846325.6811399, "CN": 33439808465.0, "CM": 114858952.71175, "CD": 15700000.0, "CR": 530688786.0, "SZ": 54690323.845467597, "SY": 1622538750.0, "KG": 1266195468.7718, "KE": 685757272.44335902, "SR": 4300000.0, "KH": 152542012.5, "SV": 3471836719.0300002, "SN": 1477678083.42189, "SL": 44218574.709027901, "KZ": 225556234.27299899, "SD": 1100122398.50772, "DO": 3887000000.0, "DJ": 32641049.735259201, "YE": 1526000000.0, "DZ": 196589288.10976499, "UY": 102871000.0, "LB": 6914055025.0995598, "LA": 41774224.630000003, "TT": 90900000.0, "TR": 1100000000.0, "LK": 4123130000.0, "TN": 2063294676.5404501, "TL": 137135947.62385899, "LR": 31442777.295859899, "LS": 610128813.55970001, "TH": 3580347364.9655499, "TG": 336597485.32394099, "VE": 143000000.0, "AF": 330753776.44999999, "IQ": 176700000.0, "IR": 1181087280.0, "AM": 1669336819.1136601, "AL": 1156021682.13726, "AO": 17972037.0, "AR": 639005839.55719197, "VU": 11768615.437982701, "IN": 53479960083.243202, "TZ": 55030881.503600501, "AZ": 1410296000.0, "ID": 6916051073.0889597, "UA": 6535000000.0}, "2011": {"BD": 12960346656.8228, "BA": 1958230199.62974, "BO": 1042996646.64182, "BI": 45463176.870496698, "BJ": 171960451.44329, "BT": 10460534.0047244, "JM": 2105606760.57846, "BW": 20437444.523904599, "BR": 2798456998.9099998, "BY": 890600000.0, "BZ": 75323553.822601303, "RW": 174255508.20243701, "RS": 3271309710.93293, "TJ": 3059871670.0, "GW": 52110121.9180611, "GT": 4523758500.0, "GY": 412200000.0, "GE": 1547274439.9000001, "GN": 64500000.0, "GM": 107909707.032934, "GH": 151601280.0, "JO": 3368028169.01408, "HR": 1347772059.99719, "HT": 1551366394.1780801, "HN": 2810592535.7063398, "PS": 1665739834.4941101, "PY": 540670000.0, "PA": 368200000.0, "PG": 16955086.2549318, "PE": 2696961722.5535302, "PK": 12263000000.0, "PH": 23053626019.012501, "ZM": 46276750.719999999, "EG": 14324300000.0, "ZA": 1158421806.40696, "EC": 2680596330.8456702, "VN": 8600000000.0, "SB": 14322190.663304601, "ET": 513238170.99183297, "ME": 343391257.83437502, "MD": 1600400000.0, "MA": 7256310891.6754398, "MM": 127075981.133091, "ML": 784108010.62120104, "MN": 279425056.53058201, "MK": 434124447.0, "MW": 25320292.519788601, "UG": 816231810.79477704, "MY": 1211496095.71246, "MX": 23588480056.0, "MZ": 156830889.67541, "FJ": 160373346.527706, "NI": 913600000.0, "NA": 15294143.843609899, "NE": 165934780.35759899, "NG": 20618849629.225899, "NP": 4216916648.9632702, "CO": 4101315891.06111, "CN": 40483340782.0, "CM": 219254989.731884, "CD": 114600000.0, "CR": 520219673.31091201, "SZ": 38126354.810082003, "KG": 1708694027.7327001, "KE": 934149203.15461397, "SR": 3893784.5278030499, "KH": 160444113.125, "SV": 3643949246.0514698, "SN": 1613911186.36674, "SL": 58811610.110121198, "KZ": 179708290.69988501, "SD": 441931223.790447, "DO": 4240700000.0, "DJ": 32359709.882343698, "YE": 1403920000.0, "DZ": 202869816.18834201, "UY": 128836000.0, "LB": 6913472231.0968304, "LA": 110297813.09, "TR": 1210000000.0, "LK": 5153010000.0, "TN": 2004498798.34729, "TL": 136896001.84200001, "LR": 359993842.54499698, "LS": 649334950.90501702, "TH": 4554062825.6256199, "VE": 138000000.0, "AF": 247054819.81, "IQ": 223000000.0, "IR": 1329781000.0, "AM": 1798624692.26173, "AL": 1125664515.9474299, "AO": 204751.10000000001, "AR": 697697825.12991595, "VU": 21765886.492138501, "IN": 62499075444.736603, "TZ": 78387435.387799799, "AZ": 1893080000.0, "ID": 6923970511.3983898, "UA": 7822000000.0}, "2012": {"BD": 14236408265.775801, "BA": 1845715376.7000899, "BO": 1110532146.9818799, "BI": 46433649.088890001, "BJ": 207775439.42418, "BT": 18144730.4308342, "JM": 2158237118.8586898, "BW": 18155587.677386101, "BR": 2582640312.73, "BY": 1053100000.0, "BZ": 75945646.688262403, "RW": 182405277.287595, "RS": 3545070783.5246401, "TJ": 3625512075.0, "GW": 45635187.632546902, "GT": 5030649506.9935198, "GY": 469258405.52263302, "GE": 1770115175.3399999, "GN": 66300000.0, "GM": 140991051.90878499, "GH": 137952000.0, "JO": 3489577464.7887301, "HT": 1612326050.46575, "HN": 2920369783.0113401, "PS": 2059691141.0945101, "PY": 634100000.0, "PA": 410900000.0, "PG": 14253844.7797246, "PE": 2787954662.5237699, "PK": 14005892000.0, "PH": 24609679612.744598, "ZM": 72864000.0, "EG": 19236400000.0, "ZA": 1084655275.8510499, "EC": 2476225961.8054299, "SB": 17172183.035254098, "ET": 624360669.89823198, "ME": 332611101.35645097, "MD": 1793330000.0, "MA": 6507905288.1990204, "MM": 274616061.70033503, "MN": 320359550.82671601, "MK": 394153574.0, "MW": 28303380.409094799, "UG": 910316842.96866095, "MY": 1319707014.5424099, "MX": 23365990957.0, "MZ": 220213602.037, "FJ": 190607763.76603201, "NI": 1016300000.0, "NA": 13489397.9023249, "NE": 151843055.04749, "NG": 20633319233.919601, "NP": 4793419078.3647404, "CO": 4018674668.2006001, "CN": 39221093635.0, "CM": 210419765.07322699, "CD": 12199487.804953201, "CR": 562342745.04609096, "SZ": 31313373.862023599, "KG": 2031374213.382, "KE": 1213552387.1798799, "SR": 8057490.75, "KH": 172106023.5625, "SV": 3910251397.9703798, "SL": 60988977.735020898, "KZ": 171297944.515044, "SD": 401482586.70265502, "DO": 4262100000.0, "DJ": 33265624.208731599, "YE": 3351000000.0, "DZ": 214841268.63545701, "UY": 121776000.0, "LB": 6730056404.6991301, "LA": 58516879.409999996, "TR": 1153000000.0, "LK": 5999552324.3749399, "TN": 2265714118.0299401, "TL": 119859807.78, "LR": 515790000.0, "LS": 554033690.89906001, "TH": 4713380624.0098104, "VE": 118000000.0, "AF": 385148127.918562, "IQ": 271000000.0, "AM": 1914983996.6162701, "AL": 1027055044.84093, "AO": 45000.0, "AR": 575491173.99565995, "VU": 22036537.530931301, "IN": 68820517837.653595, "TZ": 67383205.336340994, "AZ": 1990180000.0, "ID": 7212196577.5592003, "UA": 8449000000.0}, "2013": {"BD": 13857127756.488701, "DO": 4485500000.0, "MN": 255732281.40092099, "DJ": 35645759.364396997, "BA": 1928718699.8209, "BO": 1201339478.5981901, "YE": 3342500000.0, "BI": 48639473.899970502, "HT": 1780995273.91781, "KZ": 207247134.73890799, "BT": 11804283.7060374, "JM": 2160966583.5041399, "ZA": 970655337.20388699, "BW": 36036825.015276097, "DZ": 209640490.59801501, "BR": 2537114311.2800002, "GN": 93010000.0, "UY": 122748000.0, "FJ": 203578810.425547, "MA": 6881699960.0007401, "BY": 1213500000.0, "BZ": 74401710.370204702, "NI": 1081300000.0, "RW": 170052937.19484401, "LB": 7863563801.8459797, "LA": 59626040.310000002, "NA": 11479309.3332262, "VU": 23710130.912137199, "AF": 537523431.51487195, "TR": 1135000000.0, "LK": 6422186627.1435604, "TN": 2290512364.1381001, "TL": 33649746.710000001, "PA": 451900000.0, "LR": 383412500.0, "LS": 462478612.21732599, "TH": 5689777048.37253, "PE": 2707246389.7856202, "NP": 5551527542.2358198, "PK": 14626000000.0, "PH": 26699667193.9795, "UA": 9667000000.0, "SB": 16506126.767629899, "ZM": 53980262.060576603, "GT": 5370644500.0, "CO": 4119493056.6129999, "CN": 38818824246.0, "CM": 244059166.99198201, "CL": 300000.0, "PS": 1748291970.7160699, "AM": 2192193826.9467602, "AL": 1093922786.6889901, "EC": 2458803089.2206998, "CD": 33111316.851286799, "GE": 1945284852.3399999, "AR": 532412910.33020598, "GY": 328200000.0, "IN": 69970360846.785797, "CR": 596399211.04977596, "AZ": 1733168000.0, "ID": 7614419340.0284405, "GH": 119296000.0, "ME": 423399011.99845397, "MD": 1984920000.0, "KG": 2277998114.2017002, "MM": 229419844.59392399, "RS": 4022602527.5125999, "KH": 175950000.0, "SV": 3971079071.2634001, "MK": 376055980.89999998, "SZ": 30002132.222308699, "SR": 6993693.2785481997, "JO": 3642676056.3380299, "PY": 591044000.0, "SL": 67618450.4174072, "HN": 3136002216.4012198, "UG": 931570329.696437, "SD": 424392083.51140302, "MY": 1395888416.35937, "MX": 23022469746.0, "TZ": 59413995.0, "MZ": 217053804.87980399}}, "BX.GRT.TECH.CD.WD": {"2010": {"BD": 180910000.0, "BF": 125370000.0, "BA": 138440000.0, "BO": 132850000.0, "BI": 73440000.0, "BJ": 92220000.0, "BT": 18800000.0, "JM": 15960000.0, "BW": 20570000.0, "BR": 248420000.0, "BY": 36740000.0, "BZ": 5240000.0, "RW": 124790000.0, "RS": 127340000.0, "TJ": 39540000.0, "GW": 17780000.0, "GT": 122540000.0, "GY": 13200000.0, "GE": 122200000.0, "GN": 62040000.0, "GM": 8440000.0, "GH": 115000000.0, "OM": 3320000.0, "JO": 71600000.0, "HR": 39200000.0, "HT": 193300000.0, "HN": 53620000.0, "PS": 165690000.0, "PY": 57320000.0, "PA": 21040000.0, "PG": 313020000.0, "PE": 172280000.0, "PK": 210240000.0, "PH": 205410000.0, "ZM": 70920000.0, "EG": 165170000.0, "ZA": 160530000.0, "EC": 86440000.0, "VN": 377670000.0, "SB": 238430000.0, "ET": 175950000.0, "ME": 29100000.0, "MD": 54230000.0, "MA": 290470000.0, "MM": 56860000.0, "ML": 120060000.0, "MN": 89090000.0, "MK": 68360000.0, "MW": 80430000.0, "UG": 105360000.0, "MY": 48670000.0, "MX": 120720000.0, "MZ": 164950000.0, "FJ": 39000000.0, "NI": 101550000.0, "NA": 44020000.0, "NE": 81250000.0, "NG": 197310000.0, "NP": 122480000.0, "CI": 53320000.0, "CO": 141540000.0, "CN": 957400000.0, "CM": 154480000.0, "CD": 227980000.0, "CR": 32230000.0, "SZ": 7510000.0, "SY": 118740000.0, "KG": 57890000.0, "KE": 148430000.0, "SR": 9060000.0, "KH": 184960000.0, "SV": 61930000.0, "SN": 181910000.0, "SL": 46120000.0, "KZ": 50220000.0, "SD": 185490000.0, "DO": 45990000.0, "DJ": 16110000.0, "YE": 63380000.0, "DZ": 184580000.0, "UY": 27060000.0, "LB": 88990000.0, "LA": 109950000.0, "TT": 2470000.0, "TR": 153540000.0, "LK": 76770000.0, "TN": 161700000.0, "TL": 148280000.0, "LR": 29750000.0, "LS": 11800000.0, "TH": 115440000.0, "TG": 30170000.0, "VE": 18960000.0, "AF": 878700000.0, "IQ": 125790000.0, "IR": 72520000.0, "AM": 32090000.0, "AL": 101250000.0, "AO": 41840000.0, "AR": 75320000.0, "VU": 45050000.0, "IN": 282300000.0, "TZ": 149720000.0, "AZ": 52800000.0, "ID": 512960000.0, "UA": 236310000.0}, "2011": {"BD": 206270000.0, "BA": 116160000.0, "BO": 117870000.0, "BI": 67080000.0, "BJ": 87370000.0, "BT": 21100000.0, "JM": 16800000.0, "BW": 20130000.0, "BR": 222000000.0, "BY": 34580000.0, "BZ": 5350000.0, "RW": 142540000.0, "RS": 117380000.0, "TJ": 35510000.0, "GW": 18760000.0, "GT": 115120000.0, "GY": 17750000.0, "GE": 109920000.0, "GN": 27520000.0, "GM": 16510000.0, "GH": 118980000.0, "JO": 126780000.0, "HR": 20000.0, "HT": 175990000.0, "HN": 68160000.0, "PS": 228020000.0, "PY": 48800000.0, "PA": 22200000.0, "PG": 300700000.0, "PE": 159320000.0, "PK": 210660000.0, "PH": 191520000.0, "ZM": 94900000.0, "EG": 179210000.0, "ZA": 186510000.0, "EC": 77350000.0, "VN": 376260000.0, "SB": 215880000.0, "ET": 195080000.0, "ME": 14960000.0, "MD": 62240000.0, "MA": 171340000.0, "MM": 58470000.0, "ML": 104720000.0, "MN": 91800000.0, "MK": 44160000.0, "MW": 76900000.0, "UG": 131180000.0, "MY": 40500000.0, "MX": 113340000.0, "MZ": 192620000.0, "FJ": 38180000.0, "NI": 85050000.0, "NA": 47430000.0, "NE": 56230000.0, "NG": 270480000.0, "NP": 142250000.0, "CO": 112340000.0, "CN": 730030000.0, "CM": 131240000.0, "CD": 235570000.0, "CR": 29410000.0, "SZ": 9640000.0, "KG": 45960000.0, "KE": 205140000.0, "SR": 6470000.0, "KH": 192370000.0, "SV": 47670000.0, "SN": 155930000.0, "SL": 47440000.0, "KZ": 48300000.0, "SD": 108960000.0, "DO": 43310000.0, "DJ": 14230000.0, "YE": 53450000.0, "DZ": 73650000.0, "UY": 20980000.0, "LB": 71280000.0, "LA": 105860000.0, "TR": 149010000.0, "LK": 75980000.0, "TN": 101450000.0, "TL": 150180000.0, "LR": 34810000.0, "LS": 13650000.0, "TH": 101940000.0, "VE": 17190000.0, "AF": 877140000.0, "IQ": 89400000.0, "IR": 72930000.0, "AM": 27240000.0, "AL": 97710000.0, "AO": 35300000.0, "AR": 55570000.0, "VU": 38860000.0, "IN": 325750000.0, "TZ": 206520000.0, "AZ": 47720000.0, "ID": 553220000.0, "UA": 193180000.0}, "2012": {"BD": 201490000.0, "BA": 102630000.0, "BO": 116850000.0, "BI": 75770000.0, "BJ": 92790000.0, "BT": 26670000.0, "JM": 14950000.0, "BW": 19020000.0, "BR": 240220000.0, "BY": 29430000.0, "BZ": 4990000.0, "RW": 110240000.0, "RS": 105570000.0, "TJ": 39990000.0, "GW": 12630000.0, "GT": 90100000.0, "GY": 13970000.0, "GE": 85670000.0, "GN": 44520000.0, "GM": 21490000.0, "GH": 161860000.0, "JO": 108240000.0, "HT": 127520000.0, "HN": 64750000.0, "PS": 175880000.0, "PY": 47290000.0, "PA": 19300000.0, "PG": 356160000.0, "PE": 166700000.0, "PK": 228510000.0, "PH": 268590000.0, "ZM": 81050000.0, "EG": 196330000.0, "ZA": 179050000.0, "EC": 76680000.0, "SB": 195610000.0, "ET": 208610000.0, "ME": 12240000.0, "MD": 69530000.0, "MA": 278500000.0, "MM": 72060000.0, "MN": 90690000.0, "MK": 49940000.0, "MW": 82560000.0, "UG": 141610000.0, "MY": 45610000.0, "MX": 118920000.0, "MZ": 187570000.0, "FJ": 56100000.0, "NI": 78230000.0, "NA": 48880000.0, "NE": 64700000.0, "NG": 316730000.0, "NP": 141580000.0, "CO": 127810000.0, "CN": 676670000.0, "CM": 164950000.0, "CD": 197230000.0, "CR": 31440000.0, "SZ": 6780000.0, "KG": 56160000.0, "KE": 227140000.0, "SR": 6080000.0, "KH": 196740000.0, "SV": 52170000.0, "SL": 50270000.0, "KZ": 43090000.0, "SD": 81780000.0, "DO": 37770000.0, "DJ": 17390000.0, "YE": 52680000.0, "DZ": 167900000.0, "UY": 13640000.0, "LB": 93500000.0, "LA": 120790000.0, "TR": 160020000.0, "LK": 75580000.0, "TN": 164300000.0, "TL": 119940000.0, "LR": 44050000.0, "LS": 16250000.0, "TH": 131410000.0, "VE": 20040000.0, "AF": 901530000.0, "IQ": 119510000.0, "AM": 25340000.0, "AL": 95330000.0, "AO": 34860000.0, "AR": 56350000.0, "VU": 53840000.0, "IN": 354750000.0, "TZ": 204840000.0, "AZ": 37030000.0, "ID": 696410000.0, "UA": 198290000.0}, "2013": {"BD": 202100000.0, "DO": 29600000.0, "MN": 86880000.0, "DJ": 23440000.0, "BA": 95950000.0, "BO": 95750000.0, "YE": 55590000.0, "BI": 92690000.0, "HT": 95980000.0, "KZ": 50450000.0, "BT": 26280000.0, "JM": 13970000.0, "ZA": 166110000.0, "BW": 16520000.0, "DZ": 167600000.0, "BR": 234980000.0, "GN": 46720000.0, "UY": 12230000.0, "FJ": 45710000.0, "MA": 260770000.0, "BY": 27680000.0, "BZ": 4760000.0, "NI": 57520000.0, "RW": 105410000.0, "LB": 87060000.0, "LA": 99030000.0, "NA": 42860000.0, "VU": 40790000.0, "AF": 806090000.0, "TR": 153350000.0, "LK": 67030000.0, "TN": 167000000.0, "TL": 95170000.0, "PA": 16050000.0, "LR": 58950000.0, "LS": 12350000.0, "TH": 97030000.0, "PE": 138280000.0, "NP": 132990000.0, "PK": 260640000.0, "PH": 199150000.0, "UA": 166460000.0, "SB": 137610000.0, "ZM": 82540000.0, "GT": 59420000.0, "CO": 122820000.0, "CN": 556110000.0, "CM": 152890000.0, "CL": 61010000.0, "PS": 179180000.0, "AM": 32670000.0, "AL": 56080000.0, "EC": 67090000.0, "CD": 298700000.0, "GE": 96350000.0, "AR": 51760000.0, "GY": 8340000.0, "IN": 372040000.0, "CR": 28930000.0, "AZ": 39640000.0, "ID": 518910000.0, "GH": 166990000.0, "ME": 13170000.0, "MD": 48980000.0, "KG": 56250000.0, "MM": 94760000.0, "RS": 90850000.0, "KH": 151650000.0, "SV": 39390000.0, "MK": 34290000.0, "SZ": 6430000.0, "SR": 3800000.0, "JO": 98340000.0, "PY": 39140000.0, "SL": 38260000.0, "HN": 47340000.0, "UG": 154410000.0, "SD": 59480000.0, "MY": 32450000.0, "MX": 118440000.0, "TZ": 247800000.0, "MZ": 215790000.0}}}, "summary": "Residuals:\n       Min         1Q     Median         3Q        Max \n-3.337e+10 -2.170e+09 -1.162e+09 -3.995e+08  6.213e+10 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 9.563e+08  3.523e+08   2.714   0.0069 ** \nv1          1.850e+01  2.057e-01  89.953   <2e-16 ***\n---\nSignif. codes:  0 \u2018***\u2019 0.001 \u2018**\u2019 0.01 \u2018*\u2019 0.05 \u2018.\u2019 0.1 \u2018 \u2019 1\n\nResidual standard error: 7.434e+09 on 454 degrees of freedom\nMultiple R-squared:  0.9469,\tAdjusted R-squared:  0.9468 \nF-statistic:  8092 on 1 and 454 DF,  p-value: < 2.2e-16\n\n", "effects": {"count": "456 rows of data were used for the analysis.", "BX.GRT.TECH.CD.WD": "BX.GRT.TECH.CD.WD very very significantly affects BX.TRF.PWKR.CD.DT in a positive direction. A single unit increase in BX.GRT.TECH.CD.WD, increases BX.TRF.PWKR.CD.DT by 1.850e+01 units on average."}, "desc": "       BX.GRT.TECH.CD.WD  BX.TRF.PWKR.CD.DT\ncount       4.560000e+02       4.560000e+02\nmean        2.643297e+08       5.847086e+09\nstd         1.694257e+09       3.221572e+10\nmin         2.000000e+04       4.500000e+04\n25%         2.498500e+07       5.926340e+07\n50%         6.894500e+07       4.099425e+08\n75%         1.498350e+08       2.158919e+09\nmax         1.923999e+10       3.599928e+11\n\n[8 rows x 2 columns]"})
        try:
            data = json.loads(request.data)
            from_year, to_year, options = int(data.pop('from')), int(data.pop('to')), data.pop('options')
            highest = max(data.keys())
            indicators = {data[x]['ind']:data[x]['ind'] for x in data if 'ind' in data[x]}

            # pulls the data, removes rows with any NA (making R's life better)
            df = wbdata.get_dataframe(indicators=indicators,
                                      convert_date=True,
                                      data_date=(
                                          datetime(from_year, 1, 1),
                                          datetime(to_year, 1, 1)
                                      )).dropna()

            if not len(df):
                return jsonify({"desc": "Not enough data!",
                                "summary": "Not enough data!",
                                'effects': {'info': "Not enough data!"}, 'error': 0})

            lm_vectors, mapData = [], {}
            for num in data:
                ind_name = data[num]['ind']
                vector = FloatVector(df[ind_name])
                if num != highest:
                    robjects.globalenv[str('v' + num)] = vector
                else:
                    robjects.globalenv[str('res')] = vector
                # Store it in the server side session.
                keys = map(functions.make_key, df[ind_name].keys())
                session[ind_name] = [{keys[i]: df[ind_name][i] for i in range(len(keys))}]
                mapData[ind_name] = {}
                for key in df[ind_name].keys():
                    if functions.get_country_code(key[0]):
                        mapData[ind_name].setdefault(key[1].year, {})[functions.get_country_code(key[0])] = df[ind_name][key]

            lmr = stats.lm("res ~ {}".format(' + '.join(['v' + str(i) for i in range(1, len(data))])))
            lmr = str(base.summary(lmr))
            lmr = lmr[lmr.find('Residuals:'):]

            vals = lmr[lmr.lower().find('(intercept)'):lmr.lower().find('---')].split('\n')
            effects = {'count': str(len(df)) + ' rows of data were used for the analysis.'} #todo: add the real number
            for i in range(1, len(data)):
                row, name = vals[i].split(), data[str(i)]['ind']     #is the corresponding row of this datum
                if len(row) == 6:                                    #it is significant
                    effects[name] = "{0} {1}significantly affects {2} in a {3} direction.".format(
                        name,
                        {'*': '', '**': 'very ', '***': 'very very '}[row[5]],
                        data[highest]['ind'],
                        {1: 'positive', 0: 'negative'}[rpy2functions.sign(row[1])]
                    )
                    effects[name] += ' A single unit increase in {0}, {1} {2} by {3} units on average.'.format(
                        name,
                        {1:'increases', 0:'decreases'}[rpy2functions.sign(row[1])],
                        data[highest]['ind'],
                        rpy2functions.unsign(row[1])
                    )
                else:
                    effects[name] = name + " was not found to be a significant factor!"
                response = {"desc": str(df.describe()), "summary": lmr, 'effects': effects, 'error': 0,
                            'mapData': mapData}
            return jsonify(response)
        except Exception as e:
            return jsonify({'error': 1,
                            'err_msg': 'There was an error. Trace attached:',
                            'trace': '\n'.join(e.args) + e.message})


#todo: Code cleanup